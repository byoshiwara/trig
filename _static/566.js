"use strict";(self.webpackChunkWebComponents=self.webpackChunkWebComponents||[]).push([[566],{14566:(t,e,n)=>{var o=n(78673);class s extends o.A{constructor(t,e,n){super({}),this.containerDiv=t,this.divid=t.id,this.boxData=e,this.boxesRenderedPromise=new Promise((t=>{this.boxesRenderedResolve=t})),this.workspace=this.createWorkspace(t),this.connList=this.createConnList(t),this.ariaLive=this.createAriaLive(t),this.controlDiv=this.createControlDiv(t),this.connections=[],this.allBoxes=[],this.selectedBox=null,this.startBox=null,this.tempLine=null,this.useRunestoneServices=eBookConfig.useRunestoneServices,this.graderactive=n.graderactive||!1,this.init(),this.boxesRenderedPromise.then((()=>{this.checkServer("matching",!0)}))}init(){this.shuffle(this.boxData.left),this.shuffle(this.boxData.right),this.renderBoxes(),this.attachEvents(),window.MathJax&&MathJax.typesetPromise&&MathJax.typesetPromise()}checkCurrentAnswer(){const t=this.boxData.correctAnswers,e=this.connections.map((t=>[t.fromBox.dataset.id,t.toBox.dataset.id])),n=t.filter((t=>e.some((e=>e[0]===t[0]&&e[1]===t[1])))),o=e.filter((e=>!t.some((t=>t[0]===e[0]&&t[1]===e[1]))));this.correctCount=n.length,this.incorrectCount=o.length,this.missingCount=t.length-this.correctCount,this.denominator=this.correctCount+this.incorrectCount+this.missingCount,this.scorePercent=0===this.denominator?0:Math.max(0,Math.min(100,Math.round(this.correctCount/this.denominator*100)))}async logCurrentAnswer(t){t.event="matching",t.div_id=this.divid,t.act=`score:${t.score} connections:${JSON.stringify(t.connections)}`,t.correct=100===t.score,t.answer=JSON.stringify({connections:t.connections}),await this.logBookEvent(t)}renderFeedback(){this.connections.forEach((t=>{const e=[t.fromBox.dataset.id,t.toBox.dataset.id],n=this.boxData.correctAnswers.some((t=>t[0]===e[0]&&t[1]===e[1]));t.line.classList.remove("correct","incorrect"),t.line.classList.add(n?"correct":"incorrect")})),this.connList.innerHTML=`<strong>Score: ${this.scorePercent}%</strong>`}restoreAnswers(t){t&&(this.connections=t.answer.connections.map((t=>({fromBox:this.allBoxes.find((e=>e.dataset.id===t.from)),toBox:this.allBoxes.find((e=>e.dataset.id===t.to))}))),this.updateConnectionModel(),this.correct=t.correct),this.connections.forEach((t=>{const e=this.getCenter(t.fromBox),n=this.getCenter(t.toBox),o=this.createLineElement(e.x,e.y,n.x,n.y);o.fromBox=t.fromBox,o.toBox=t.toBox,this.svg.appendChild(o),t.line=o}))}checkLocalStorage(){if(this.graderactive)return;const t=localStorage.getItem(this.divid);if(t){const e=JSON.parse(t);this.connections=e.connections.map((t=>({fromBox:this.allBoxes.find((e=>e.dataset.id===t.from)),toBox:this.allBoxes.find((e=>e.dataset.id===t.to))}))),this.updateConnectionModel(),this.correctCount=e.correctCount,this.incorrectCount=e.incorrectCount,this.missingCount=e.missingCount,this.scorePercent=e.score,this.restoreAnswers(),this.renderFeedback()}}setLocalStorage(){const t={connections:this.connections.map((t=>({from:t.fromBox.dataset.id,to:t.toBox.dataset.id}))),score:this.scorePercent,correctCount:this.correctCount,incorrectCount:this.incorrectCount,missingCount:this.missingCount};localStorage.setItem(this.divid,JSON.stringify(t))}disableInteraction(){}createWorkspace(t){const e=document.createElement("div");e.className="matching-workspace";const n=document.createElement("div");n.className="left-column",this.leftColumn=n;const o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.classList.add("connector-svg"),this.svg=o;const s=document.createElement("div");return s.className="right-column",this.rightColumn=s,e.appendChild(n),e.appendChild(o),e.appendChild(s),t.insertBefore(e,t.firstChild),e}createConnList(t){const e=document.createElement("div");return e.className="conn-list",e.innerHTML="<strong>Connections:</strong><br>",t.appendChild(e),e}createAriaLive(t){const e=document.createElement("div");return e.className="aria-live",e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),t.appendChild(e),e}createControlDiv(t){const e=document.createElement("div");e.className="control-div";const n=document.createElement("button");n.className="grade-button",n.textContent="Grade";const o=document.createElement("button");return o.className="reset-button",o.textContent="Reset",e.appendChild(n),e.appendChild(o),t.appendChild(e),e}shuffle(t){for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}renderBoxes(){this.boxData.left.forEach((({id:t,label:e})=>{const n=this.createBox(t,e,"drag");this.leftColumn.appendChild(n),this.allBoxes.push(n)})),this.boxData.right.forEach((({id:t,label:e})=>{const n=this.createBox(t,e,"drop");this.rightColumn.appendChild(n),this.allBoxes.push(n)}));const t=Array.from(this.workspace.querySelectorAll("img"));0===t.length&&this.boxesRenderedResolve();const e=t.map((t=>"function"==typeof t.decode?t.decode():t.complete&&0!==t.naturalWidth?Promise.resolve():new Promise((e=>{t.addEventListener("load",(()=>e())),t.addEventListener("error",(()=>e()))}))));Promise.all(e).then((()=>{this.boxesRenderedResolve()}))}createBox(t,e,n){const o=document.createElement("div");return o.className="box",o.dataset.id=t,o.dataset.role=n,o.innerHTML=e,o.tabIndex=0,o.setAttribute("role","button"),o.setAttribute("aria-label",`${"drag"===n?"Draggable":"Droppable"}: ${e}`),o}getCenter(t){const e=t.getBoundingClientRect(),n=this.workspace.getBoundingClientRect();return{x:e.left-n.left+e.width/2,y:e.top-n.top+e.height/2}}createLineElement(t,e,n,o){const s=document.createElementNS("http://www.w3.org/2000/svg","line");return s.setAttribute("x1",t),s.setAttribute("y1",e),s.setAttribute("x2",n),s.setAttribute("y2",o),s.setAttribute("class","line"),s.setAttribute("tabindex","0"),s.setAttribute("role","button"),s.setAttribute("aria-label","Connection line. Press Delete to remove."),s.addEventListener("click",(()=>{this.removeLine(s)})),s.addEventListener("keydown",(t=>{"Delete"!==t.key&&"Backspace"!==t.key||(t.preventDefault(),this.removeLine(s))})),s}removeLine(t){this.svg.removeChild(t);const e=this.connections.findIndex((e=>e.fromBox===t.fromBox&&e.toBox===t.toBox||e.fromBox===t.toBox&&e.toBox===t.fromBox));-1!==e&&this.connections.splice(e,1),this.updateConnectionModel()}isConnected(t,e){return this.connections.some((n=>n.fromBox===t&&n.toBox===e||n.fromBox===e&&n.toBox===t))}createPermanentLine(t,e){if(t.dataset.role===e.dataset.role)return void alert("You can only connect a draggable to a droppable.");if(this.isConnected(t,e))return;const n=this.getCenter(t),o=this.getCenter(e),s=this.createLineElement(n.x,n.y,o.x,o.y);s.fromBox=t,s.toBox=e,this.svg.appendChild(s),this.connections.push({fromBox:t,toBox:e,line:s}),this.updateConnectionModel(),this.ariaLive&&(this.ariaLive.textContent=`Connected ${t.textContent} to ${e.textContent}`)}updateConnectionModel(){this.connList.innerHTML="<strong>Connections:</strong><br>",this.connections.forEach((t=>{const e=t.fromBox.textContent;let n=t.toBox.textContent;n||(n=t.toBox.querySelector("img").alt);const o=document.createElement("div");o.className="conn-entry",o.textContent=`${e} â†’ ${n}`,this.connList.appendChild(o)}))}gradeConnections(){this.checkCurrentAnswer(),this.renderFeedback(),this.logCurrentAnswer({score:this.scorePercent,correctCount:this.correctCount,incorrectCount:this.incorrectCount,missingCount:this.missingCount,connections:this.connections.map((t=>({from:t.fromBox.dataset.id,to:t.toBox.dataset.id})))}),this.setLocalStorage()}resetConnections(){this.connections.forEach((t=>{t.line&&t.line.parentNode===this.svg&&this.svg.removeChild(t.line)})),this.connections.length=0,this.updateConnectionModel(),this.ariaLive&&(this.ariaLive.textContent="All connections have been cleared.")}attachEvents(){this.allBoxes.forEach((t=>{t.addEventListener("mousedown",(e=>{if(e.ctrlKey||e.metaKey){e.preventDefault(),this.startBox=t;const n=this.getCenter(this.startBox);this.tempLine=this.createLineElement(n.x,n.y,n.x,n.y),this.tempLine.setAttribute("stroke","gray"),this.tempLine.setAttribute("stroke-dasharray","4"),this.svg.appendChild(this.tempLine),document.addEventListener("mousemove",this.updateTempLine),document.addEventListener("mouseup",this.finishConnection)}})),t.addEventListener("keydown",(e=>{if("Enter"===e.key)if(e.preventDefault(),this.selectedBox){t!==this.selectedBox&&this.createPermanentLine(this.selectedBox,t),this.selectedBox.classList.remove("selected"),this.selectedBox=null;const e=this.allBoxes.indexOf(t),n=this.allBoxes[e+1];n?n.focus():this.allBoxes[0].focus()}else this.selectedBox=t,t.classList.add("selected")})),t.addEventListener("mouseenter",(()=>{this.connections.forEach((e=>{e.fromBox===t||e.toBox===t?(e.line.classList.add("highlighted"),e.line.classList.remove("faded")):(e.line.classList.add("faded"),e.line.classList.remove("highlighted"))}))})),t.addEventListener("mouseleave",(()=>{this.connections.forEach((t=>{t.line.classList.remove("highlighted","faded")}))}))}));const t=this.containerDiv.querySelector(".grade-button"),e=this.containerDiv.querySelector(".reset-button");t&&t.addEventListener("click",(()=>this.gradeConnections())),e&&e.addEventListener("click",(()=>this.resetConnections())),window.addEventListener("resize",(()=>{this.connections.forEach((t=>{const e=this.getCenter(t.fromBox),n=this.getCenter(t.toBox);t.line.setAttribute("x1",e.x),t.line.setAttribute("y1",e.y),t.line.setAttribute("x2",n.x),t.line.setAttribute("y2",n.y)}))}))}updateTempLine=t=>{if(!this.startBox||!this.tempLine)return;const e=this.getCenter(this.startBox);this.tempLine.setAttribute("x1",e.x),this.tempLine.setAttribute("y1",e.y);const n=this.workspace.getBoundingClientRect(),o=t.clientX-n.left,s=t.clientY-n.top;this.tempLine.setAttribute("x2",o),this.tempLine.setAttribute("y2",s)};finishConnection=t=>{this.tempLine&&(this.svg.removeChild(this.tempLine),this.tempLine=null);const e=this.allBoxes.find((e=>e.contains(t.target)&&e!==this.startBox));this.startBox&&e&&this.createPermanentLine(this.startBox,e),this.startBox=null,document.removeEventListener("mousemove",this.updateTempLine),document.removeEventListener("mouseup",this.finishConnection)}}document.addEventListener("runestone:login-complete",(()=>{document.querySelectorAll('[data-component="matching"]').forEach((t=>{const e=t.querySelector("script");if(e){let n;try{n="text/xml"==e.type?function(t){const e=(new DOMParser).parseFromString(t,"application/xml"),n=e.querySelector("parsererror");if(n)throw new Error("XML parse error: "+n.textContent);function o(t){return Array.from(e.querySelectorAll(t)).map((t=>{const e=t.querySelector("id"),n=t.querySelector("label");return{id:e?e.textContent.trim():"",label:n?n.innerHTML.trim():""}}))}return{left:o("premise"),right:o("response"),correctAnswers:Array.from(e.querySelectorAll("edge")).map((t=>Array.from(t.querySelectorAll("label")).slice(0,2).map((t=>t.textContent.trim()))))}}(e.textContent):JSON.parse(e.textContent);let o={};window.componentMap[t.id]=new s(t,n,o)}catch(t){console.error("Failed to parse boxData JSON:",t)}}}))}))}}]);
//# sourceMappingURL=566.js.map